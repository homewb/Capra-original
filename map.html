<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Directions service</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" 
      src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyADWB-lvKkICS6jzKXoP-it10OWZI7Ce7w">
    </script>
    <script type="text/javascript">
      var directionsDisplay;
      var directionsService = new google.maps.DirectionsService();
      var map;
      var elevator;
      var chart;
      var chartMoa;
      var chartGoogle;
      var mousemarker = null;
      var mousemarker_moa = null;
      var mousemarker_google = null;
      var elevations_path = null;
      var elevations_moa = null;
      var elevations_google = null;
      var marker;
      var infowindow = new google.maps.InfoWindow();
      var path;
      var path_NonContour;
      var path_Dist;
      var path_Moa = new Array();
      var path_moa_points = new Array();;

      google.load('visualization', '1', {packages: ['columnchart']});

      var colors = ['#99FF33', '#009999', '#FFFF99', '#FF66FF', '#FF9999', '#800000', '#FF0000', '#FF9900'];

      function initialize() {
    	chart = new google.visualization.ColumnChart(document.getElementById('elevation_chart'));
    	chartMoa = new google.visualization.ColumnChart(document.getElementById('elevation_chart_moa'));
    	chartGoogle = new google.visualization.ColumnChart(document.getElementById('elevation_chart_google'));
        
    	directionsDisplay = new google.maps.DirectionsRenderer();
        var mapOptions = {
          zoom:8,
          mapTypeId: 'terrain'
        };
  
        map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
        calcRoute();
        directionsDisplay.setMap(map);
  
        //Create an ElevationService
        elevator = new google.maps.ElevationService();

        // Add a listener for the click event and call getElevation on that location
        google.maps.event.addListener(map, 'click', getElevation);
        //google.maps.event.addListener(chart, 'onmouseover', getMarker);
        
        // Label a path on the map 
        calcPath();
        path.setMap(map);
  
        for (var i = 0; i < getMoaSize(); i++) {
	      calcMoa(i);
	      path_Moa[i].setMap(map);
	      google.maps.event.addListener(path_Moa[i], 'click', getLine);
	      path_Moa[i].getPath().forEach(function(routePoint, index) {
		    var point = {
			  point: routePoint,
			  pathIndex: i
		    };
		    path_moa_points.push(point);
	      })
        }
        
        google.visualization.events.addListener(chart, 'onmouseover', getMarker);
        google.visualization.events.addListener(chartMoa, 'onmouseover', getMoaMarker);
  
      }

      // Load path data that is generated by original CAPRA algorithm
      function calcPath() {
	    var pathPlanCoordinates = [];
	    var size = getPathSize(0);
	    
	    console.log(size);
	    var startLat = getStartLat();
	    var startLng = getStartLng();
	    var endLat = getEndLat();
	    var endLng = getEndLng();
	  
	    pathPlanCoordinates.push(new google.maps.LatLng(startLat, startLng));
	
	    var firstLat = getFirstLat(0);
	    var firstLng = getFirstLng(0);
	    pathPlanCoordinates.push(new google.maps.LatLng(firstLat, firstLng));
	
	    for (i = 0; i < size; i++) {
		  var lat = getLat(i, 0);
		  var lng = getLng(i, 0);
		  pathPlanCoordinates.push(new google.maps.LatLng(lat, lng));
	    }
	    pathPlanCoordinates.push(new google.maps.LatLng(endLat, endLng));
	    
	    console.log('New nodes has been loaded...');
	
	    // Create a request for elevation_chart 
	    var pathRequest = {
		  'path': pathPlanCoordinates,
		  'samples': 256
	    }
	
	    elevator.getElevationAlongPath(pathRequest, plotElevation);
	
	    path = new google.maps.Polyline({
	      path: pathPlanCoordinates,
	      geodesic: true,
	      strokeColor: '#FF0000',
	      strokeOpacity: 0.6,
	      strokeWeight: 4
	    });
	
	    google.maps.event.addListener(path, 'click', getLine);
      }

      function plotElevation(results, status) {
	    if (status != google.maps.ElevationStatus.OK) {
		  return;
	    }
	    elevations_path = results;
	
	    var elevationPath = [];
	    for (var i = 0; i < results.length; i++) {
		  elevationPath.push(elevations_path[i].location);
	    }
	
	    var data = new google.visualization.DataTable();
	    data.addColumn('string', 'Sample');
	    data.addColumn('number', 'Elevation');
	    for (var i = 0; i < results.length; i++) {
		  data.addRow(['', elevations_path[i].elevation]);
	    }
	
	    document.getElementById('elevation_chart').style.display = 'block';
	    chart.draw (data, {
		  height: 150,
		  legend: 'none',
		  titleY: 'CAPRA Elevation(m)'
	    });
      }

      function calcRoute() {
	    var startLat = getStartLat();
	    var startLng = getStartLng();
	    var endLat = getEndLat();
	    var endLng = getEndLng();
	    var start = new google.maps.LatLng(startLat, startLng);
	    var end = new google.maps.LatLng(endLat, endLng);
	    var request = {
		  origin:start,
		  destination:end,
		  travelMode: google.maps.TravelMode.WALKING
		};
	    directionsService.route(request, function(response, status) {
		  if (status == google.maps.DirectionsStatus.OK) {
		    directionsDisplay.setDirections(response);
		    elevator.getElevationAlongPath({
		          path: response.routes[0].overview_path,
		          samples: 256
		        }, plotElevationGoogle);
		  }
	    });
      }

      function calcMoa(pathIndex) {
	    var pathPlanCoordinates = [];
	    var size = getMoaPathSize(pathIndex);
	    var startLat = getStartLat();
	    var startLng = getStartLng();
	    var endLat = getEndLat();
	    var endLng = getEndLng();
	  
	    pathPlanCoordinates.push(new google.maps.LatLng(startLat, startLng));
	
	    var firstLat = getMoaFirstLat(pathIndex);
	    var firstLng = getMoaFirstLng(pathIndex);
	    pathPlanCoordinates.push(new google.maps.LatLng(firstLat, firstLng));
	
	    for (var j = 0; j < size; j++) {
		  var lat = getMoaLat(j, pathIndex);
		  var lng = getMoaLng(j, pathIndex);
		  pathPlanCoordinates.push(new google.maps.LatLng(lat, lng));
	    }
	    pathPlanCoordinates.push(new google.maps.LatLng(endLat, endLng));
	
	    var lineSymbol = {
		  path: 'M 0,-1 0,1',
		  strokeOpacity: 1,
		  scale: 4
		};
	
	    var newPath = new google.maps.Polyline({
	      path: pathPlanCoordinates,
	      geodesic: true,
	      strokeColor: colors[pathIndex],
	      strokeOpacity: 0.6,
	      strokeWeight: 2,
	      icons: [{
	        icon: lineSymbol,
	        offset: '0',
	        repeat: '20px'
	      }]
	    });
	
	    path_Moa.push(newPath);
      }

      function plotElevationMoa(results, status) {
	    if (status != google.maps.ElevationStatus.OK) {
		  return;
	    }
	    elevations_moa = results;
	
	    var elevationPath = [];
	    for (var i = 0; i < results.length; i++) {
		  elevationPath.push(elevations_moa[i].location);
	    }
	
	    var data = new google.visualization.DataTable();
	    data.addColumn('string', 'Sample');
	    data.addColumn('number', 'Elevation');
	    for (var i = 0; i < results.length; i++) {
		  data.addRow(['', elevations_moa[i].elevation]);
	    }
	
	    document.getElementById('elevation_chart_moa').style.display = 'block';
	    chartMoa.draw (data, {
		  height: 150,
		  legend: 'none',
		  titleY: 'MOA Elevation(m)'
	    });
      }
      
      function plotElevationGoogle(results, status) {
  	    if (status != google.maps.ElevationStatus.OK) {
  		  return;
  	    }
  	    elevations_google = results;
  	
  	    var elevationPath = [];
  	    for (var i = 0; i < results.length; i++) {
  		  elevationPath.push(elevations_google[i].location);
  	    }
  	
  	    var data = new google.visualization.DataTable();
  	    data.addColumn('string', 'Sample');
  	    data.addColumn('number', 'Elevation');
  	    for (var i = 0; i < results.length; i++) {
  		  data.addRow(['', elevations_google[i].elevation]);
  	    }
  	
  	    document.getElementById('elevation_chart_google').style.display = 'block';
  	    chartGoogle.draw (data, {
  		  height: 150,
  		  legend: 'none',
  		  titleY: 'Google Elevation(m)'
  	    });
        }

      function getElevation(event) {
	    var locations = [];

	    // Retrieve the clicked location and push it on the array
	    var clickedLocation = event.latLng;
	    locations.push(clickedLocation);

	    // Create a LocationElevationRequest object using the array's one value
	    var positionalRequest = {
	      'locations': locations
	    }

	    // Initiate the location request
	    elevator.getElevationForLocations(positionalRequest, function(results, status) {
	      if (status == google.maps.ElevationStatus.OK) {
	    	  
	        // Retrieve the first result
	        if (results[0]) {
	        	
	          // Open an info window indicating the elevation at the clicked position
	          infowindow.setContent('The elevation at this point <br>is ' + parseInt(results[0].elevation) + ' meters.');
	          infowindow.setPosition(clickedLocation);
	          infowindow.open(map);
	        } 
	        else {
	          alert('No results found');
	        }
	      } 
	      else {
	        alert('Elevation service failed due to: ' + status);
	      }
	    });
	  }

      function getMarker(event) {  	  
    	if (mousemarker == null) {
    	  mousemarker = new google.maps.Marker({
    	    position: elevations_path[event.row].location,
    	    map: map,
    	    icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
    	  });
    	} 
    	else {
    	    mousemarker.setPosition(elevations_path[event.row].location);
    	}
	  }
      
      function getMoaMarker(event) {  	  
      	if (mousemarker_moa == null) {
      		mousemarker_moa = new google.maps.Marker({
      	    position: elevations_moa[event.row].location,
      	    map: map,
      	    icon: "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
      	  });
      	} 
      	else {
      		mousemarker_moa.setPosition(elevations_moa[event.row].location);
      	}
  	  }

      function getLine(event) {
	    var currentLatLng = event.latLng;
	    var minPoint = path_moa_points[0];
	    var minDistance = google.maps.geometry.spherical.computeDistanceBetween(currentLatLng, path_moa_points[0].point);
	    for (var i = 1; i < path_moa_points.length; i++) {
		  var distance = google.maps.geometry.spherical.computeDistanceBetween(currentLatLng, path_moa_points[i].point);
		  if (distance < minDistance) {
			minPoint = path_moa_points[i];
			minDistance = distance;
		  }
	    }
	
	    var pathIndex = minPoint.pathIndex;
	    var currentPath = path_Moa[pathIndex].getPath().getArray();
	
	    // Create a request for elevation_chart_moa
	    var pathRequest = {
		  'path': currentPath,
		  'samples': 256
	    }
	
	    elevator.getElevationAlongPath(pathRequest, plotElevationMoa);
      }

      google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
    <div id="elevation_chart"></div>
    <div id="elevation_chart_google"></div>
    <div id="elevation_chart_moa"></div>
    
  </body>
</html>